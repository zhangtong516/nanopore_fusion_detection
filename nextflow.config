
params {
  samplesheet = ''
  outdir = 'results'
  dorado_model = ''
  dorado_device = 'gpu'
  jaffa_sif = 'docker://davidsongroup/jaffa:latest'
  jaffa_ref_dir = "/home/users/astar/acrc/aicloudtestuser3/scratch/reference/GRCh38/jaffa_hg38/"
}

process {
  // Default process configuration
  executor = 'slurm'
  clusterOptions = '-V --partition=cpu' 
  // clusterOptions = { ' -V --partition=testqueue --gres=gpu:1  -A aicloud-testgroup ' }  // Remove account specification or update with your actual account
  penv = 'OpenMP'
  // errorStrategy = { task.attempt < 2 ? 'retry' : 'finish' }
  pollInterval = '30 sec'
  exitReadTimeout = "120 sec"
  withName: DORADO_BASECALL {
    cpus = 8
    memory = '32 GB'
    time = '8h'
    accelerator = 1
    // container = 'ontresearch/dorado:latest'
    containerOptions = '--gpus all --shm-size=8g'
    clusterOptions = '-V --partition=testqueue -A aicloud-testgroup --gres=gpu:1'  // Request 1 GPU explicitly
  }

  withName: RUN_JAFFAL {
    container = ${params.jaffa_sif} 
    time = '8h'
    cpus = 8
    memory = '48 GB'
  }

  withName: MAKE_REPORT {
    cpus = 1
  }
}
profile  {
  // Disable Docker
  docker {
      enabled = false
  }

  // Enable Singularity
  singularity {
      enabled = true
      autoMounts = true
      cacheDir = params.cacheDir
  }

  apptainer {
    enabled = true
    autoMounts = true
    runOptions = '--cleanenv --containall'
  }
}

// Reporting
report {
    enabled = true
    overwrite = true
    file = "${params.outdir}/reports/nextflow_report.html"
}

timeline {
    enabled = true
    overwrite = true
    file = "${params.outdir}/reports/timeline.html"
}

trace {
    enabled = true
    overwrite = true
    file = "${params.outdir}/reports/trace.txt"
}